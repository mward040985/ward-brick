<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Brickwork CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .sidebar { height: 100vh; background: #2c3e50; color: white; overflow-y: auto; }
        .nav-link { color: #bdc3c7 !important; }
        .nav-link.active, .nav-link:hover { background: #34495e; color: white !important; }
        .card { transition: all 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        table th { background: #2c3e50; color: white; }
        #loginModal .modal-dialog { max-width: 400px; }
    </style>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"Ward Brickwork CRM\",
        \"short_name\": \"WB CRM\",
        \"start_url\": \".\",
        \"display\": \"standalone\",
        \"background_color\": \"#f8f9fa\",
        \"theme_color\": \"#2c3e50\",
        \"icons\": [{
            \"src\": \"https://via.placeholder.com/192?text=WB\",
            \"sizes\": \"192x192\",
            \"type\": \"image/png\"
        }]
    }">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-3">
            <h3 class="text-center mb-4"><i class="fas fa-brick"></i> Ward Brickwork CRM</h3>
            <ul class="nav flex-column" id="nav-menu" style="display:none;">
                <li><a href="#" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('clients')"><i class="fas fa-users"></i> Clients</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('sites')"><i class="fas fa-map-marker-alt"></i> Sites</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('gangs')"><i class="fas fa-user-friends"></i> Gangs</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('contracts')"><i class="fas fa-file-contract"></i> Contracts & CRM</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('cvr')"><i class="fas fa-chart-line"></i> CVR</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('payroll')"><i class="fas fa-money-check"></i> Payroll</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('site-measures')"><i class="fas fa-ruler"></i> Site Measures</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('cashflow')"><i class="fas fa-money-bill-wave"></i> Cash Flow</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('overheads')"><i class="fas fa-file-invoice-dollar"></i> Overheads</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('qa')"><i class="fas fa-check-circle"></i> QA Records (On-Site)</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('measures')"><i class="fas fa-calculator"></i> Book Measures (On-Site)</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('reconciliation')"><i class="fas fa-balance-scale"></i> Reconciliation</a></li>
                <li><a href="#" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#" class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
            <hr class="text-secondary">
            <button class="btn btn-outline-light w-100 mt-3" onclick="exportData()">Export Data (Backup/To Xero CSV)</button>
            <button class="btn btn-outline-light w-100 mt-2" onclick="document.getElementById('importFile').click()">Import Data</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
        </div>

        <!-- Main Content -->
        <div class="col-md-10 p-4" id="main-content">
            <!-- Dashboard -->
            <div id="dashboard-section" class="d-none">
                <h2>Dashboard</h2>
                <div class="row g-3" id="stats-row"></div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>Contract Status</h5>
                                <canvas id="contractChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>Recent Activity</h5>
                                <ul id="recent-list" class="list-group"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Section -->
            <div id="clients-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Clients</h2>
                    <button class="btn btn-success" onclick="showClientModal()">+ New Client</button>
                </div>
                <table class="table table-hover" id="clients-table">
                    <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Address</th><th>Type</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Sites Section -->
            <div id="sites-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Sites</h2>
                    <button class="btn btn-success" onclick="showSiteModal()">+ New Site</button>
                </div>
                <table class="table table-hover" id="sites-table">
                    <thead><tr><th>Name</th><th>Main Contractor</th><th>Address</th><th>Site Contact</th><th>Number</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Gangs Section -->
            <div id="gangs-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gangs</h2>
                    <button class="btn btn-success" onclick="showGangModal()">+ New Gang</button>
                </div>
                <table class="table table-hover" id="gangs-table">
                    <thead><tr><th>Name</th><th>Size</th><th>Location</th><th>Mobile</th><th>Email</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Contracts Section -->
            <div id="contracts-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Contracts & CRM</h2>
                    <button class="btn btn-success" onclick="showContractModal()">+ New Contract</button>
                </div>
                <table class="table table-hover" id="contracts-table">
                    <thead><tr><th>Client</th><th>Site</th><th>Contract No</th><th>Sum</th><th>Terms</th><th>Retention</th><th>Applied</th><th>Certified</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- CVR Section -->
            <div id="cvr-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Cost Value Reconciliation (CVR)</h2>
                    <button class="btn btn-success" onclick="showCvrModal()">+ New CVR</button>
                </div>
                <table class="table table-hover" id="cvr-table">
                    <thead><tr><th>Contract</th><th>Month</th><th>Forecast GP</th><th>Actual GP</th><th>Margin</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Payroll Section -->
            <div id="payroll-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Payroll</h2>
                    <button class="btn btn-success" onclick="showPayrollModal()">+ New Payroll Week</button>
                </div>
                <table class="table table-hover" id="payroll-table">
                    <thead><tr><th>Week Ending</th><th>Total Gross</th><th>Total Net</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Site Measures Section -->
            <div id="site-measures-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Site Measures</h2>
                    <button class="btn btn-success" onclick="showSiteMeasureModal()">+ New Week Measures</button>
                </div>
                <table class="table table-hover" id="site-measures-table">
                    <thead><tr><th>Week Ending</th><th>Total Measure</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Cash Flow Section -->
            <div id="cashflow-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Cash Flow</h2>
                    <button class="btn btn-success" onclick="showCashflowModal()">+ New Month</button>
                </div>
                <table class="table table-hover" id="cashflow-table">
                    <thead><tr><th>Month</th><th>Total In</th><th>Total Out</th><th>Remaining</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Overheads Section -->
            <div id="overheads-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Overheads</h2>
                    <button class="btn btn-success" onclick="showOverheadModal()">+ New Overhead</button>
                </div>
                <table class="table table-hover" id="overheads-table">
                    <thead><tr><th>Name</th><th>Description</th><th>Amount</th><th>Frequency</th><th>Method</th><th>Bank</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- QA Records Section -->
            <div id="qa-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>QA Records (On-Site)</h2>
                    <button class="btn btn-success" onclick="showQaModal()">+ New QA Record</button>
                </div>
                <table class="table table-hover" id="qa-table">
                    <thead><tr><th>Site</th><th>Date</th><th>Type</th><th>Geo</th><th>Photos</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Measures Section -->
            <div id="measures-section" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Book Measures (On-Site)</h2>
                    <button class="btn btn-success" onclick="showMeasureModal()">+ New Measure</button>
                </div>
                <table class="table table-hover" id="measures-table">
                    <thead><tr><th>Site</th><th>Gang</th><th>Date</th><th>Measure</th><th>Notes</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Reconciliation Section -->
            <div id="reconciliation-section" class="d-none">
                <h2>Reconciliation</h2>
                <table class="table table-hover" id="reconciliation-table">
                    <thead><tr><th>Week</th><th>Site Totals</th><th>Payroll</th><th>Match</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="d-none">
                <h2>Reports</h2>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h5>GP by Contract</h5>
                                <canvas id="gpChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login to Ward Brickwork CRM</h5>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label>Role</label>
                        <select class="form-select" id="userRole">
                            <option>Administrator</option>
                            <option>Accounts</option>
                            <option>MD</option>
                            <option>Quantity Surveyor</option>
                            <option>Sales Manager</option>
                            <option>Contracts Manager</option>
                            <option>Site Manager</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Password</label>
                        <input type="password" class="form-control" id="userPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="login()">Login</button>
            </div>
        </div>
    </div>
</div>

<!-- Client Modal (example, similar for others) -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientModalTitle">New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="clientId">
                    <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="clientName" required></div>
                    <div class="mb-3"><label>Phone</label><input type="tel" class="form-control" id="clientPhone"></div>
                    <div class="mb-3"><label>Email</label><input type="email" class="form-control" id="clientEmail"></div>
                    <div class="mb-3"><label>Address</label><textarea class="form-control" id="clientAddress"></textarea></div>
                    <div class="mb-3"><label>Type</label>
                        <select class="form-select" id="clientType">
                            <option>Residential</option>
                            <option>Commercial</option>
                            <option>Lead</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveClient()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Add similar modals for Sites, Gangs, Contracts, CVR, Payroll, Site Measures, Cash Flow, Overheads, QA, Measures -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ==================== DATA & ROLES ====================
let currentRole = '';
let data = {
    users: [ // Simple users, password 'pass' for all in demo
        {role: 'Administrator', password: 'pass'},
        {role: 'Accounts', password: 'pass'},
        {role: 'MD', password: 'pass'},
        {role: 'Quantity Surveyor', password: 'pass'},
        {role: 'Sales Manager', password: 'pass'},
        {role: 'Contracts Manager', password: 'pass'},
        {role: 'Site Manager', password: 'pass'}
    ],
    clients: [],
    sites: [],
    gangs: [],
    contracts: [],
    cvrs: [],
    payroll: [],
    siteMeasures: [],
    cashFlows: [],
    overheads: [],
    qaRecords: [],
    measures: []
};

// Load sample data from attached sheets
function loadSampleData() {
    if (localStorage.getItem('ward_brickwork_crm')) {
        data = JSON.parse(localStorage.getItem('ward_brickwork_crm'));
        return;
    }
    // Clients from example
    data.clients = [
        {id:1, name:"Macrane", phone:"07709288686", email:"macrane@example.com", address:"Brooklands Close, Sale M35 9JX", type:"Commercial"},
        {id:2, name:"Emma Rice", phone:"07709288686", email:"emma@example.com", address:"9 Audely Road, Levenshulme, M19 3EG", type:"Residential"}
    ];
    // Sites from Sites sheet
    data.sites = [
        {id:1, name:"Brooklands", mainContractor:"Macrane Construction", address:"Brooklands Close, Sale M35 9JX", siteContact:"Mike Ward", number:"07709288686"},
        {id:2, name:"Audely Road", mainContractor:"Emma Rice", address:"9 Audely Road, Levenshulme, M19 3EG", siteContact:"Mike Ward", number:"07709288686"}
    ];
    // Gangs from Gangs sheet
    data.gangs = [
        {id:1, name:"Scott Capper (2+1)", size:"2+1", location:"Oldham", mobile:"07594 589554", email:"s.capper208@gmail"}
    ];
    // Payroll from Pay Roll sheet
    data.payroll = [
        {id:1, weekEnding:"2025-08-31", operatives: [
            {name:"Alex Miller", gross:562.5, cis:112.5, net:450, paid:"YES", onHold:"YES"},
            {name:"Mike Ward", gross:908, cis:181.6, net:726.4, paid:"YES"},
            {name:"Nigle Fox", gross:883, cis:176.6, net:706.4, paid:"YES"},
            {name:"Scott Capper", gross:908, cis:181.6, net:726.4, paid:"YES"}
        ]}
    ];
    // Site Measures from Site Totals
    data.siteMeasures = [
        {id:1, weekEnding:"2025-08-31", sites: [
            {siteName:"Brooklands", gang:"Scott Capper (2+1)", measure:2574.01},
            {siteName:"Audely Road", gang:"Scott Capper (2+1)", measure:0}
        ]}
    ];
    // Cash Flows from AUG sheet
    data.cashFlows = [
        {id:1, month:"AUG", weeks: [
            {week:"WE 10.08.25", ins: [{type:"CIB", amount:1172.25}], outs: [{type:"Salary", amount:577}, {type:"Fuel", amount:40}, /* add more */], remaining:395.98},
            // Add other weeks similarly
        ]}
    ];
    // Overheads from OH sheet
    data.overheads = [
        {id:1, name:"O2", desc:"Phone", amount:22, freq:"Month", method:"D/D", bank:"Starling"},
        // Add others
    ];
    // Contracts from CRM August
    data.contracts = [
        {id:1, client:"Macrane", site:"Brooklands", contractNo:"CT-101-25", sum:32054.8, terms:5, retention:0, applications: [
            {appNo:1, dateApplied:"2025-08-10", amount:3117.11, certified:3117.11, difference:0, percent:0, received:"Yes", finalPaymentDate:"2025-08-15", actualPaymentDate:"2025-08-19", diff:-4, dpm:0, dueLessRetention:3117.11, paid:"Yes"}
            // Add more
        ]}
    ];
    // CVRs from CVR sheet
    data.cvrs = [
        {id:1, contractId:1, month:"AUG", forecast: {value:32052, labour:22042.16, gp:10009.84, margin:0.3123}, actual: {applied:9179.24, certified:9179.24, diff:0, percent:0, pmd:0, labour:7154.05, gp:2025.19, margin:0.2206, pmm:0}, onMonth: /* similar */, weeks: [{week:"WE 10.08", amount:2494}, /* more */]}
    ];
    saveData();
}

function saveData() {
    localStorage.setItem('ward_brickwork_crm', JSON.stringify(data));
}

// ==================== LOGIN ====================
function login() {
    const role = document.getElementById('userRole').value;
    const password = document.getElementById('userPassword').value;
    const user = data.users.find(u => u.role === role && u.password === password);
    if (user) {
        currentRole = role;
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        document.getElementById('nav-menu').style.display = 'block';
        showSection('dashboard');
        // Hide/show sections based on role if needed (e.g., Site Manager sees on-site only)
        if (role === 'Site Manager') {
            // Hide non-on-site
            document.querySelectorAll('.nav-link:not([onclick*="qa"]):not([onclick*="measures"]):not([onclick*="dashboard"]):not([onclick*="logout"])').forEach(el => el.style.display = 'none');
        }
    } else {
        alert('Invalid credentials');
    }
}

function logout() {
    currentRole = '';
    document.getElementById('nav-menu').style.display = 'none';
    showLogin();
}

function showLogin() {
    new bootstrap.Modal(document.getElementById('loginModal')).show();
}

// ==================== RENDER FUNCTIONS ====================
function showSection(section) {
    document.querySelectorAll('#main-content > div').forEach(div => div.classList.add('d-none'));
    document.getElementById(section + '-section').classList.remove('d-none');
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    event.target.classList.add('active');
    if (section === 'dashboard') updateDashboard();
    if (section === 'clients') renderClients();
    // Add render calls for other sections similarly
    // e.g., if (section === 'sites') renderSites();
    // Implement renderSites, renderGangs, etc.
}

// Implement render functions for each section, similar to previous

// ==================== MODALS & CRUD ====================
function showClientModal(id = null) {
    // Populate if edit, show modal
    new bootstrap.Modal(document.getElementById('clientModal')).show();
}
// Implement saveClient, deleteClient, etc.

// Similar for all other entities

// For QA, in modal, add file input for photos, get geolocation
function getGeo(callback) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => callback({lat: pos.coords.latitude, lng: pos.coords.longitude}));
    }
}

// For export, add CSV for Xero (payroll, invoices)
function exportData() {
    // JSON backup
    const blobJson = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const urlJson = URL.createObjectURL(blobJson);
    const aJson = document.createElement('a');
    aJson.href = urlJson; aJson.download = 'ward_backup.json'; aJson.click();

    // Example CSV for payroll
    let csv = 'Operative,Gross,CIS,Net,Paid\n';
    data.payroll.forEach(p => {
        p.operatives.forEach(o => {
            csv += `${o.name},${o.gross},${o.cis},${o.net},${o.paid}\n`;
        });
    });
    const blobCsv = new Blob([csv], {type: 'text/csv'});
    const urlCsv = URL.createObjectURL(blobCsv);
    const aCsv = document.createElement('a');
    aCsv.href = urlCsv; aCsv.download = 'payroll_for_xero.csv'; aCsv.click();
    // Add more CSVs as needed
}

// Import similar

// Reconciliation: compare siteMeasures total to payroll gross for week
function renderReconciliation() {
    // Calculate match
}

// Init
loadSampleData();
showLogin();
</script>
</body>
</html>
